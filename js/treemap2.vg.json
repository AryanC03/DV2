{
    "$schema": "https://vega.github.io/schema/vega/v6.json",
    "description": "A treemap showing the number of disaster events in each state, grouped by disaster type.",
    "width": 800,
    "height": 600,
    "padding": 2.5,
    "data": [
        {
            "name": "disasters",
            "url": "data/disasters_treemap.csv",
            "format": {
                "type": "csv"
            },
            "transform": [
                {
                    "type": "aggregate",
                    "groupby": [
                        "State",
                        "DisasterType"
                    ],
                    "ops": [
                        "count"
                    ],
                    "as": [
                        "count"
                    ]
                },
                {
                    "type": "treemap",
                    "field": "count",
                    "sort": {
                        "field": "count",
                        "order": "descending"
                    },
                    "method": "binary",
                    "round": true,
                    "size": [
                        {
                            "signal": "width"
                        },
                        {
                            "signal": "height"
                        }
                    ]
                }
            ]
        },
        {
            "name": "nodes",
            "source": "disasters",
            "transform": [
                {
                    "type": "filter",
                    "expr": "datum.children"
                },
                {
                    "type": "formula",
                    "expr": "datum.data && datum.data.DisasterType ? datum.data.DisasterType : datum.name",
                    "as": "category"
                },
                {
                    "type": "formula",
                    "expr": "datum.data && datum.data.id ? datum.data.id : datum.name",
                    "as": "label"
                }
            ]
        },
        {
            "name": "leaves",
            "source": "disasters",
            "transform": [
                {
                    "type": "filter",
                    "expr": "!datum.children"
                },
                {
                    "type": "formula",
                    "expr": "datum.data && datum.data.DisasterType ? datum.data.DisasterType : 'Unknown'",
                    "as": "category"
                },
                {
                    "type": "formula",
                    "expr": "datum.data && datum.data.State ? datum.data.State : datum.name",
                    "as": "state"
                },
                {
                    "type": "formula",
                    "expr": "datum.data && datum.data.size ? datum.data.size : 0",
                    "as": "count"
                },
                {
                    "type": "formula",
                    "expr": "(datum.x1 - datum.x0) * (datum.y1 - datum.y0)",
                    "as": "area"
                }
            ]
        }
    ],
    "scales": [
        {
            "name": "color",
            "type": "ordinal",
            "domain": {
                "data": "nodes",
                "field": "name"
            },
            "range": [
                "#3182bd",
                "#6baed6",
                "#9ecae1",
                "#c6dbef",
                "#e6550d",
                "#fd8d3c",
                "#fdae6b",
                "#fdd0a2",
                "#31a354",
                "#74c476",
                "#a1d99b",
                "#c7e9c0",
                "#756bb1",
                "#9e9ac8",
                "#bcbddc",
                "#dadaeb",
                "#636363",
                "#969696",
                "#bdbdbd",
                "#d9d9d9"
            ]
        },
        {
            "name": "size",
            "type": "ordinal",
            "domain": [
                0,
                1,
                2,
                3
            ],
            "range": [
                256,
                28,
                20,
                14
            ]
        },
        {
            "name": "opacity",
            "type": "ordinal",
            "domain": [
                0,
                1,
                2,
                3
            ],
            "range": [
                0.15,
                0.5,
                0.8,
                1.0
            ]
        }
    ],
    "marks": [
        {
            "type": "rect",
            "from": {
                "data": "nodes"
            },
            "interactive": false,
            "encode": {
                "enter": {
                    "fill": {
                        "scale": "color",
                        "field": "name"
                    }
                },
                "update": {
                    "x": {
                        "field": "x0"
                    },
                    "y": {
                        "field": "y0"
                    },
                    "x2": {
                        "field": "x1"
                    },
                    "y2": {
                        "field": "y1"
                    }
                }
            }
        },
        {
            "type": "rect",
            "from": {
                "data": "leaves"
            },
            "encode": {
                "enter": {
                    "stroke": {
                        "value": "#fff"
                    }
                },
                "update": {
                    "x": {
                        "field": "x0"
                    },
                    "y": {
                        "field": "y0"
                    },
                    "x2": {
                        "field": "x1"
                    },
                    "y2": {
                        "field": "y1"
                    },
                    "fill": {
                        "value": "transparent"
                    }
                },
                "hover": {
                    "fill": {
                        "value": "red"
                    }
                }
            }
        },
        {
            "type": "text",
            "from": {
                "data": "nodes"
            },
            "interactive": false,
            "encode": {
                "enter": {
                    "font": {
                        "value": "Helvetica Neue, Arial"
                    },
                    "align": {
                        "value": "center"
                    },
                    "baseline": {
                        "value": "middle"
                    },
                    "fill": {
                        "value": "#000"
                    },
                    "text": {
                        "field": "name"
                    },
                    "fontSize": {
                        "scale": "size",
                        "field": "depth"
                    },
                    "fillOpacity": {
                        "scale": "opacity",
                        "field": "depth"
                    }
                },
                "update": {
                    "x": {
                        "signal": "0.5 * (datum.x0 + datum.x1)"
                    },
                    "y": {
                        "signal": "0.5 * (datum.y0 + datum.y1)"
                    }
                }
            }
        }
    ]
}